---
title: "03.5.1_bkmr-all"
author: "Jagadeesh Puvvula"
date: "2023-02-20"
output: pdf_document
---

```{r, echo=FALSE, message=FALSE}

library(pacman)
pacman::p_load(tidyverse, janitor, bkmr, Matrix, fields, bindrcpp)
path <- "E:/BBK17/pj/data_2023apr/obs_w_outcome/"

dat<- read_csv(paste0(path, "wppsi_f_analy.csv"))

```

```{r, echo=FALSE, message=FALSE}
dat<- dat |>
  mutate_if(is.numeric, round, 4) |>
  clean_names() |>
  mutate(pb = if_else(cohort == "1", pb * 10, pb))|>
  rename(Pb=pb, Hg=hg, DMA=dma, DDE= dde, PBDE_47 = pbde47,
         PCB_118=pcb118, PCB_138=pcb138, PCB_153=pcb153,
         PCB_180=pcb180, PFHxS=pfhxs, PFOA=pfoa, PFOS=pfos,
         BCEtP=bcetp, BDCPP=bdcpp, DBuP=dbup, DPhP=dphp,
         TCS=tcs, BPA=bpa, MBP=mbp, MBZP=mbzp, MCPP=mcpp,
         sigma_DEHP=dehp, MEP=mep, MIBP=mibp, di_Ethyl_OP=op_de,
         di_Methyl_OP=op_dm, B_PB=b_pb, M_PB=m_pb, P_PB=p_pb, city=center,
         mom_edu_cat=edu3)|>
  mutate(race_bin = ifelse(race == "white", 1, 2))|>
  select(c(Pb, Hg, DMA, DDE, PBDE_47, PCB_118, PCB_138, PCB_153, PCB_180,
          PFHxS, PFOA, PFOS, BCEtP, BDCPP, DBuP, DPhP, TCS, BPA, MBP, MBZP,
          MCPP, sigma_DEHP, MEP, MIBP, di_Ethyl_OP, di_Methyl_OP, 
          B_PB, M_PB, P_PB, cotinine, home_score_total, mom_age, 
          cohort, city, sex, race_bin,  mom_edu_cat, parity_n, 
           wppsi_fsiq, wppsi_viq, wppsi_piq,)) 
```

#for 29 chemicals
```{r}
# for all chemicals select 1:32
dat <- dat |>
  select(1:41) |>
  drop_na()|>
  mutate_at(vars(1:30), ~log10(.+0.0000001)) |>
  drop_na() |>
  mutate_all(as.numeric)

dat_mirec <- dat |> filter(cohort=="2")
```


#for 16 chemicals
```{r}
chemicals_16<- c("Pb","Hg", 
              "DDE", "PBDE_47","PCB_118","PCB_138", "PCB_153","PCB_180",
              "MBP","MBZP","MCPP", "sigma_DEHP","MEP","MIBP",
              "M_PB", "P_PB")
chem_group_16<- c(rep(1,times=2), rep(2,times=6), rep(3, times=6),
               rep(4,times=2))
outcomes<-c("wppsi_fsiq","wppsi_viq", "wppsi_piq")
covariates<- c("cotinine", "home_score_total", "mom_age", "cohort",
                           "city", "sex", "race", "mom_edu_cat", "parity_n" )

# for all chemicals select 1:32
dat <- dat |>
  select(c(chemicals_16, covariates, outcomes)) |>
  drop_na()|>
  mutate_at(vars(1:17), ~log10(.+0.0000001)) |>
  drop_na() |>
  mutate_all(as.numeric)

table(dat$sex, dat$cohort)


dat_mirec <- dat |> filter(cohort=="2")
```


#grpreg LASSO with neg coef for at least one outcome: 15 chem
```{r}
chemicals_15<- c("Pb", "PFHxS", "P_PB", "di_Methyl_OP",
                 "BDCPP", "DPhP", 
                 "TCS", "BPA",
                 "PBDE_47","PCB_138","PCB_153",
                 "MBP","MBZP","MCPP", "MEP")

chem_group_15<- c(rep(1,times=4), rep(2,times=2), rep(3, times=2),
               rep(4,times=3),rep(5,times=4))
outcomes<-c("wppsi_fsiq","wppsi_viq", "wppsi_piq")
covariates<- c("cotinine", "home_score_total", "mom_age", "cohort",
                           "city", "sex", "race_bin", "mom_edu_cat", "parity_n" )

# for all chemicals select 1:32
dat <- dat |>
  select(c(chemicals_15, covariates, outcomes)) |>
  drop_na()|>
  mutate_at(vars(1:17), ~log10(.+0.0000001)) |>
  drop_na() |>
  mutate_all(as.numeric)

table(dat$sex, dat$cohort)


dat_mirec <- dat |> filter(cohort=="2")
```


#grpreg LASSO with pos coef for at least one outcome: 14 chem
```{r}
chemicals_14<- c("Hg","DMA",
                 "DDE","PCB_118","PCB_180",
                 "PFOA","PFOS",
                 "BCEtP","DBuP",
                 "sigma_DEHP","MIBP",
                 "di_Methyl_OP",
                 "B_PB","M_PB")

chem_group_14<- c(rep(1,times=2), rep(2,times=3), rep(3, times=2),
               rep(4,times=2),rep(5,times=2),rep(6,times=1),rep(7,times=2))
outcomes<-c("wppsi_fsiq","wppsi_viq", "wppsi_piq")
covariates<- c("cotinine", "home_score_total", "mom_age", "cohort",
                           "city", "sex", "race_bin", "mom_edu_cat", "parity_n" )

# for all chemicals select 1:32
dat <- dat |>
  select(c(chemicals_14, covariates, outcomes)) |>
  drop_na()|>
  mutate_at(vars(1:15), ~log10(.+0.0000001)) |>
  drop_na() |>
  mutate_all(as.numeric)

table(dat$sex, dat$cohort)


dat_mirec <- dat |> filter(cohort=="2")
```

-------------------------------------------

=================================================================================
#BKMR loop
#Non-linearlity modeled using #knots = (15/sample size)*100
#convergence tested at 100 iterations
# TUNE nd value in knots100 object and iter in kmbayes function
```{r}
bkmr_cohort <- function(data, folder_path, include_sex = TRUE, include_cohort = TRUE,
                       ln_mixture_vars = NULL, outcome_vars = NULL, covariate_vars = NULL, groups) {
  
  set.seed(2023)
  
  # Subset data based on cohort level and update covariate list accordingly
  for (cohort_level in c("all", "home", "mirec")) {
    
    if (include_cohort) {
      if (cohort_level == "all") {
        cohort_data <- data
      } else if (cohort_level == "home") {
        cohort_data <- subset(data, cohort == "1")
        covariate_vars <- covariate_vars[!(covariate_vars %in% c("cohort", "city"))]
      } else if (cohort_level == "mirec") {
        cohort_data <- subset(data, cohort == "2")
        covariate_vars <- covariate_vars[!(covariate_vars %in% c("cohort"))]
      } else {
        stop("Invalid cohort level")
      }
    } else {
      cohort_data <- data
    }
    
    # Extract variables needed for bkmr
    ln_mixture <- as.matrix(cohort_data[, ln_mixture_vars])
    outcome <- as.matrix(cohort_data[, outcome_vars])
    covariates <- as.matrix(cohort_data[, covariate_vars])
    
    # Run bkmr for each outcome variable
    for(i in 1:ncol(outcome)) {
      
      # Create knots for bkmr
      knots100 <- fields::cover.design(ln_mixture, nd = round(0.15 * nrow(ln_mixture)))$design
      
      bkmr <- kmbayes(y = outcome[,i], Z = ln_mixture, X = covariates, iter = 50000, 
                      verbose = TRUE, varsel = TRUE, 
                      groups = groups, 
                      knots = knots100)
      
      save(bkmr, file = paste0(folder_path, "/bkmr_",
                               "all_",
                               if (include_cohort) cohort_level else "all", "_",
                               colnames(outcome)[i], ".rda"))
    }
    
  }
  
}


#Sex-specific function
bkmr_sex <- function(data, folder_path, include_sex = TRUE,
                      ln_mixture_vars = NULL, outcome_vars = NULL, covariate_vars = NULL, groups) {
  
  set.seed(2023)
  
  # Subset data based on sex level and update covariate list accordingly
  for (sex_level in c("male", "female")) {
    
    if (include_sex) {
      if (sex_level == "male") {
        sex_data <- subset(data, sex == "1")
        covariate_vars <- covariate_vars[!(covariate_vars %in% c("sex"))]
      } else if (sex_level == "female") {
        sex_data <- subset(data, sex == "2")
        covariate_vars <- covariate_vars[!(covariate_vars %in% c("sex"))]
      } else {
        stop("Invalid sex level")
      }
    } else {
      sex_data <- data
    }
    
    # Extract variables needed for bkmr
    ln_mixture <- as.matrix(sex_data[, ln_mixture_vars])
    outcome <- as.matrix(sex_data[, outcome_vars])
    covariates <- as.matrix(sex_data[, covariate_vars])
    
    # Run bkmr for each outcome variable
    for(i in 1:ncol(outcome)) {
      
      # Create knots for bkmr
      knots100 <- fields::cover.design(ln_mixture, nd = round(0.15 * nrow(ln_mixture)))$design
      
      bkmr <- kmbayes(y = outcome[,i], Z = ln_mixture, X = covariates, iter = 50000, 
                      verbose = TRUE, varsel = TRUE, 
                      groups = groups, 
                      knots = knots100)
      
      save(bkmr, file = paste0(folder_path, "/bkmr_", 
                               if (include_sex) sex_level else "all", "_",
                               "all_",
                               colnames(outcome)[i], ".rda"))
    }
    
  }
  
}

```

#Run model (select either sex or cohort to TRUE: Convergence issue)
```{r}
chemicals<- c("Pb","Hg", "DMA","DDE","PBDE_47","PCB_118","PCB_138", "PCB_153","PCB_180","PFHxS","PFOA","PFOS","BCEtP","BDCPP", "DBuP","DPhP","TCS","BPA","MBP","MBZP","MCPP", "sigma_DEHP", "MEP","MIBP","di_Ethyl_OP", "di_Methyl_OP", "B_PB","M_PB", "P_PB")
chem_group<- c(rep(1,times=3), rep(2,times=6), rep(3, times=3),rep(4,times=4), rep(5, times=2), rep(6,times=6),rep(7,times=2), rep(8, times=3))

bkmr_sex(data=dat, 
          folder_path = "E:/BBK17/pj/data_2023apr/results/bkmr", 
          ln_mixture_vars= chemicals,
          groups=chem_group,
          outcome_vars=c("wppsi_fsiq","wppsi_viq", "wppsi_piq"), 
          covariate_vars=c("cotinine", "home_score_total", "mom_age", "cohort",
                           "city", "sex", "race", "mom_edu_cat", "parity_n" ), 
          include_sex = TRUE)
#gender sepcific estimates only for mirec
bkmr_sex(data=dat_mirec, 
          folder_path = "E:/BBK17/pj/data_2023apr/results/bkmr/mirec_sex", 
          ln_mixture_vars= chemicals,
          groups=chem_group,
          outcome_vars=c("wppsi_fsiq","wppsi_viq", "wppsi_piq"), 
          covariate_vars=c("cotinine", "home_score_total", "mom_age", "cohort",
                           "city", "sex", "race", "mom_edu_cat", "parity_n" ), 
          include_sex = TRUE)

bkmr_cohort(data=dat, 
          folder_path = "E:/BBK17/pj/data_2023apr/results/bkmr", 
          ln_mixture_vars= chemicals,
          groups=chem_group,
          outcome_vars=c("wppsi_fsiq","wppsi_viq", "wppsi_piq"), 
          covariate_vars=c("cotinine", "home_score_total", "mom_age", "cohort",
                           "city", "sex", "race", "mom_edu_cat", "parity_n" ), 
          include_cohort = TRUE)
```

#16 chemicals
```{r}
bkmr_sex(data=dat, 
          folder_path = "E:/BBK17/pj/data_2023apr/results/bkmr/16_chem", 
          ln_mixture_vars= chemicals_16,
          groups=chem_group_16,
          outcome_vars=outcomes, 
          covariate_vars=covariates, 
          include_sex = TRUE)
#gender sepcific estimates only for mirec
bkmr_sex(data=dat_mirec, 
          folder_path = "E:/BBK17/pj/data_2023apr/results/bkmr/16_chem/mirec_sex", 
          ln_mixture_vars= chemicals_16,
          groups=chem_group_16,
          outcome_vars=outcomes, 
          covariate_vars=covariates, 
          include_sex = TRUE)

bkmr_cohort(data=dat, 
          folder_path = "E:/BBK17/pj/data_2023apr/results/bkmr/16_chem", 
          ln_mixture_vars= chemicals_16,
          groups=chem_group_16,
          outcome_vars=outcomes, 
          covariate_vars=covariates, 
          include_cohort = TRUE)
```

#grpreg LASSO neg. coef: 15 chemicals
```{r}
bkmr_sex(data=dat, 
          folder_path = "E:/BBK17/pj/data_2023apr/results/bkmr/lasso_15chem", 
          ln_mixture_vars= chemicals_15,
          groups=chem_group_15,
          outcome_vars=outcomes, 
          covariate_vars=covariates, 
          include_sex = TRUE)
#gender sepcific estimates only for mirec
bkmr_sex(data=dat_mirec, 
          folder_path = "E:/BBK17/pj/data_2023apr/results/bkmr/lasso_15chem/mirec_sex", 
          ln_mixture_vars= chemicals_15,
          groups=chem_group_15,
          outcome_vars=outcomes, 
          covariate_vars=covariates, 
          include_sex = TRUE)

bkmr_cohort(data=dat, 
          folder_path = "E:/BBK17/pj/data_2023apr/results/bkmr/lasso_15chem", 
          ln_mixture_vars= chemicals_15,
          groups=chem_group_15,
          outcome_vars=outcomes, 
          covariate_vars=covariates, 
          include_cohort = TRUE)
```

#grpreg LASSO pos. coef: 14 chemicals
```{r}
bkmr_sex(data=dat, 
          folder_path = "E:/BBK17/pj/data_2023apr/results/bkmr/lasso_pos14chem", 
          ln_mixture_vars= chemicals_14,
          groups=chem_group_14,
          outcome_vars=outcomes, 
          covariate_vars=covariates, 
          include_sex = TRUE)
#gender sepcific estimates only for mirec
bkmr_sex(data=dat_mirec, 
          folder_path = "E:/BBK17/pj/data_2023apr/results/bkmr/lasso_pos14chem/mirec_sex", 
          ln_mixture_vars= chemicals_14,
          groups=chem_group_14,
          outcome_vars=outcomes, 
          covariate_vars=covariates, 
          include_sex = TRUE)

bkmr_cohort(data=dat, 
          folder_path = "E:/BBK17/pj/data_2023apr/results/bkmr/lasso_pos14chem", 
          ln_mixture_vars= chemicals_14,
          groups=chem_group_14,
          outcome_vars=outcomes, 
          covariate_vars=covariates, 
          include_cohort = TRUE)
```


###############################################################################
###############################################################################

#Function to extract results from model objects. 
```{r}
extract_data_from_folder <- function(folder_location) {
  library(bkmr)
  
  # Get a list of all .rda files in the folder
  rda_files <- list.files(folder_location, pattern = ".rda$")
  
  # Initialize empty data frames for pips and overall risk
  pips_df <- data.frame()
  overall_risk_df <- data.frame()
  
  # Loop through each .rda file in the folder
  for (rda_file in rda_files) {
    # Load the bkmr object from the .rda file
    load(file.path(folder_location, rda_file))
    
    # Split the file name into its component parts
    file_parts <- strsplit(rda_file, "_")[[1]]
    model_name <- file_parts[1]
    data_name <- file_parts[2]
    outcome_name <- file_parts[3]
    covariate_names <- paste(file_parts[4:(length(file_parts)-1)], collapse = "_")
    measure_name <- gsub(".rda", "", file_parts[length(file_parts)])
    
    # Extract the PIPs and add them to the pips_df data frame
    pips <- ExtractPIPs(bkmr) %>% as.data.frame()
    pips$model_name <- model_name
    pips$data_name <- data_name
    pips$outcome_name <- outcome_name
    pips$covariate_names <- covariate_names
    pips$measure_name <- measure_name
    pips_df <- bind_rows(pips_df, pips)
    
    # Extract the overall risk and add it to the overall_risk_df data frame
    sel <- seq(25000, 50000, by = 50)
    overall_risk <- OverallRiskSummaries(fit = bkmr, qs = seq(0.10, 0.90, by = 0.05), q.fixed = 0.5, method = "approx", sel = sel)
    overall_risk$model_name <- model_name
    overall_risk$data_name <- data_name
    overall_risk$outcome_name <- outcome_name
    overall_risk$covariate_names <- covariate_names
    overall_risk$measure_name <- measure_name
    overall_risk_df <- bind_rows(overall_risk_df, overall_risk)
  }
  
  # Return the pips and overall risk data frames
  return(list(pips_df = pips_df, overall_risk_df = overall_risk_df))
}
```

#Extracting PIPs and overall estimates
```{r}
results <- extract_data_from_folder("E:/BBK17/pj/data_2023apr/results/bkmr/lasso_pos14chem")
```

#prepare data for plotting
```{r}
overall_risk<- results[2] |>as.data.frame() |>
  clean_names()|>
  rename("outcome" = "overall_risk_df_measure_name",
         "cohort" = "overall_risk_df_outcome_name",
         "gender"= "overall_risk_df_data_name") |>
  mutate(cohort = fct_recode(as.factor(cohort), Pooled = "all", HOME = "home", MIREC = "mirec")) |>
  mutate(outcome = fct_recode(as.factor(outcome), FSIQ = "fsiq", VIQ = "viq", PIQ = "piq")) |>
  mutate(gender = fct_recode(as.factor(gender), All = "all", Female = "female", Male = "male"))
```

#plotting overall estimates
```{r}
ggplot(overall_risk, aes(overall_risk_df_quantile, overall_risk_df_est, 
                         ymin = overall_risk_df_est - 1.96*overall_risk_df_sd, 
                         ymax = overall_risk_df_est + 1.96*overall_risk_df_sd)) + 
    geom_hline(yintercept = 00, linetype = "dashed", color = "gray") + 
    geom_pointrange(size = 0.15, aes(color = ifelse((overall_risk_df_est - 1.96 * overall_risk_df_sd) <= 0 &
                                                  (overall_risk_df_est + 1.96 * overall_risk_df_sd) >= 0,
                                                "Non-significant", "Significant"))) + 
  scale_color_manual(values = c("Non-significant" = "#0072B2", "Significant" = "#D55E00")) +
    labs(x=NULL,
       y=expression(paste(beta[bkmr]," [95% CrI]")),
       title = "",
       caption = "")+
  theme_bw()+
    facet_grid(gender~outcome*cohort,scales = "free", space = "free_x", switch = "x")+
    theme(axis.line = element_line(colour = "black"),
          axis.text=element_text(size=10), 
          axis.title=element_text(size=10,face="bold"),
          strip.text = element_text(size=10),
          axis.text.x = element_text(angle = 0, hjust = 1, vjust = 1, size = 10),
          axis.text.y = element_text(size = 10), 
          panel.spacing.x=unit(0.5, "lines"),
          panel.spacing.y=unit(0.5, "lines"),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.major.y = element_blank(),
          plot.caption = element_text(size = 6),
          plot.title=element_text(size = 10, hjust = 0),
          panel.border = element_blank(),
          text=element_text(size=10),
          axis.ticks.x=element_blank(),
          strip.text.x=element_text(size=10,angle=0),
          strip.text.y = element_text(size=10),
          strip.placement = "outside",
          strip.background = element_rect(fill=NULL, colour = NULL),
          legend.box.just = "center",
          legend.spacing = unit(0, "cm"),
          legend.position = "bottom",
          legend.box = "horizontal",
          legend.direction = "horizontal",
          legend.text = element_text(size = 8),
          legend.key = element_blank(),
          legend.key.height = unit(3, "mm")) +
  guides(col=guide_legend(title = "Statistical significance"))+
  scale_x_continuous(breaks = seq(0.2, 0.8, by = 0.3),
                     labels = seq(0.2, 0.8, by = 0.3))

```

#save effect estimate plots
```{r}
ggsave("E:/BBK17/pj/data_2023apr/results/bkmr/lasso_pos14chem/lasso_pos14chem_est.tiff", 
       width = 16,height = 10,
       dpi=300)
```



# Function to extract pips for all bkmr runs
```{r}
extract_pips <- function(folder_location) {
  library(bkmr)
  rda_files <- list.files(folder_location, pattern = "\\.rda$", full.names = TRUE)
  pips_list <- lapply(rda_files, function(file) {
    load(file)
    pip <- as.data.frame(ExtractPIPs(bkmr))
    pip$file_name <- sub(".*/(.*)\\.rda", "\\1", file)
    pip
  })
  pips_df <- do.call(rbind, pips_list)
  return(pips_df)
}
```

# extract pips
```{r}
pip_df<- extract_pips("E:/BBK17/pj/data_2023apr/results/bkmr/lasso_15chem")
write_csv(pip_df, "E:/BBK17/pj/data_2023apr/results/bkmr/lasso_15chem/lasso_neg_pips.csv")
```

# Shiny data format
```{r}
pos_pip_df<- read_csv("E:/BBK17/pj/data_2023apr/results/bkmr/lasso_pos14chem/lasso_pos_pips.csv") |>
  mutate(lasso_dir="pos")
neg_pip_df<- read_csv("E:/BBK17/pj/data_2023apr/results/bkmr/lasso_15chem/lasso_neg_pips.csv")|>
  mutate(lasso_dir="neg")
pip_df<- bind_rows(pos_pip_df, neg_pip_df) |>
  mutate(comps = str_remove(file_name, "bkmr_")) |>
  separate(comps, c("gender", "cohort", "wppsi", "outcome"), sep = "_") 


```

#shiny app
```{r}
# Define the UI
ui <- fluidPage(
  titlePanel("BKMR output - PIPs"),
  sidebarLayout(
    sidebarPanel(
      selectInput("file_name", "Select a file name:",
                  choices = unique(pip_df$file_name)),
      selectInput("lasso_dir", "Select a lasso_dir:",
                  choices = unique(pip_df$lasso_dir))
    ),
    mainPanel(
      fluidRow(
        column(12,
               tableOutput("table")
        )
      ),
      fluidRow(
        column(6,
               actionButton("sort_groupPIP", "Sort by GroupPIP"),
        ),
        column(6,
               actionButton("sort_condPIP", "Sort by CondPIP")
        )
      )
    )
  )
)

# Define the server
server <- function(input, output) {
  
  # Filter the data based on the input values
  filtered_df <- reactive({
    pip_df %>%
      filter(file_name == input$file_name, lasso_dir == input$lasso_dir) %>%
      select(variable, group, groupPIP, condPIP)
  })
  
  # Generate the output table
  output$table <- renderTable({
    df <- filtered_df()
    df$group <- sapply(df$group, function(x) {
      paste0(x)
    })
    df
  }, sanitize.text.function = function(x) x)
  
  # Sort the data by groupPIP
  sorted_df_groupPIP <- eventReactive(input$sort_groupPIP, {
    df <- filtered_df()
    df <- df[order(df$groupPIP), ]
    df
  })
  
  # Sort the data by condPIP
  sorted_df_condPIP <- eventReactive(input$sort_condPIP, {
    df <- filtered_df()
    df <- df[order(df$condPIP), ]
    df
  })
  
  # Update the output table based on the sort buttons
  observeEvent(input$sort_groupPIP, {
    output$table <- renderTable({
      sorted_df_groupPIP()
    }, sanitize.text.function = function(x) x)
  })
  
  observeEvent(input$sort_condPIP, {
    output$table <- renderTable({
      sorted_df_condPIP()
    }, sanitize.text.function = function(x) x)
  })
  
}

# Run the app
shinyApp(ui = ui, server = server)

```








