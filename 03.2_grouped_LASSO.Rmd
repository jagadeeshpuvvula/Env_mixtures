---
title: "03.2_grouped_LASSO"
author: "Jagadeesh Puvvula"
date: "2023-02-09"
output: pdf_document
---
Below models adjusted for cotinine, education, parity, home_score, race
```{r, echo=FALSE}
library(tidyverse)
library(janitor)
library(reshape2)
library(grpreg)
```

```{r, echo=FALSE}
dat<- read_csv("E:/BBK17/pj/wppsi_exp_out_comb/wppsi_home_mirec.csv") |>
  mutate_if(is.numeric, round, 4) |>
  drop_na() |>
  clean_names() |>
  rename(Pb=pbsg, Hg=hgsg, DMA=dma_sg, DDE= dde_lp, PBDE_47 = pbde47_lp,
         PCB_118=pcb118_lp, PCB_138=pcb138_lp, PCB_153=pcb153_lp,
         PCB_180=pcb180_lp, PFHxS=pf_hx_spl, PFOA=pfoapl, PFOS=pfospl,
         BCEtP=bcetp_sg, BDCPP=bdcpp_sg, DBuP=dbup_sg, DPhP=dphp_sg,
         TCS=tcs_sg, BPA=bpa_sg, MBP=mbp_sg, MBZP=mbzp_sg, MCPP=mcpp_sg,
         sigma_DEHP=dehp, MEP=mep_sg, MIBP=mibp_sg, di_Ethyl_OP=op_de,
         di_Methyl_OP=op_dm, B_PB=b_pb, M_PB=m_pb, P_PB=p_pb)

dat<- dat|>
  mutate(race_bin = if_else(race_bin=="white", 1, 0))
```

Pre-process data
```{r}
# exposure and outcome variables
numeric_vars <- sapply(dat, is.numeric)

# Convert numeric variables to log2 scale
dat[c(5:37)] <- log2(dat[c(5:37)])

#scale outcome variable
dat<- dat |>
  mutate(wppsi_fsiq=scale(dat$wppsi_fsiq, center=T))|>
  mutate(wppsi_viq=scale(dat$wppsi_piq, center=T))|>
  mutate(wppsi_piq=scale(dat$wppsi_viq, center=T))
```



data prep - WPPSI FSIQ
```{r, echo=FALSE}
set.seed(123, "L'Ecuyer-CMRG")

# Define the predictor variables
x <- as.matrix(dat[c(5:34,41:44, 48)])
y <- as.matrix(dat[, 35])

# group index for X variables
v.group <- as.factor(c(1,1,2,0,1,6,3,1,3,5,5,5,5,5,3,6,6,
                       6,6,6,7,7,7,2,5,8,8,4,4,4,0,0,0,0,0))
```

MODEL -FSIQ
```{r, echo=FALSE, fig.height=10, fig.width=10, dpi=300}
cv_lasso_3 <- cv.grpreg(x, y, v.group, 
                        penalty = "grLasso", seed = 123,
                        n.lambda = 200, max.iter = 20000)


#Find the lambda that results in the smallest CV error
best_lasso_3 <- cv_lasso_3$lambda.min

#Fit model with cross-validated lambda
fit_lasso_3 <- grpreg(x, y, v.group, penalty = "grLasso", lambda = best_lasso_3)

#Look at coefficients from model with best lambda
fit_lasso_3$beta

##prediction and MSE using train dataset
grlasso.pred <-  predict(fit_lasso_3, x)
grlasso_MSE <-  mean((grlasso.pred - y)^2)
grlasso_MSE

lasso_beta_3 <- as_tibble(fit_lasso_3$beta, rownames = "variable") %>% 
  rename(beta = 2) %>% 
  filter(variable != "(Intercept)") %>% 
  mutate(group3 = v.group,method = "Grouped Lasso")

#Filter out covariates
lasso_beta_3 |> 
  filter(v.group %in% c("1", "2", "3", "4", "5",
                        "6", "7", "8")) |>  
  ggplot(aes(x = variable, y = round(beta, 5))) + 
  geom_point() + theme_minimal() + geom_hline(yintercept = 0, color = "blue", linetype = "dashed") +
  facet_wrap(~ group3, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + coord_flip() + 
  labs(title = "Lasso Coefficients for 8 Group Model\nWith lambda values extracted from 10-fold cross-validation\nOutcome: WPPSI-FSIQ",
       y = "Beta Coefficient", x = "Variable")
```

data prep - WPPSI VIQ
```{r, echo=FALSE}
set.seed(123, "L'Ecuyer-CMRG")

# Define the predictor variables
x <- as.matrix(dat[c(5:7, 9:34)])
y <- as.matrix(dat[, 36])

# group index for X variables
v.group <- as.factor(c(1,1,2,1,6,3,1,3,5,5,5,5,5,3,6,6,6,6,6,7,7,7,2,5,8,8,4,4,4))

gr_lasso<- grpreg(x, y, v.group, penalty="grLasso")
plot(gr_lasso)
```

MODEL -VIQ
```{r, echo=FALSE, fig.height=10, fig.width=10, dpi=300}
cv_lasso_viq <- cv.grpreg(x, y, v.group, 
                        penalty = "grLasso", seed = 123,
                        n.lambda = 200, max.iter = 20000)


#Find the lambda that results in the smallest CV error
best_lasso_viq <- cv_lasso_viq$lambda.min

#Fit model with cross-validated lambda
fit_lasso_viq <- grpreg(x, y, v.group, penalty = "grLasso", lambda = best_lasso_viq)

#Look at coefficients from model with best lambda
fit_lasso_viq$beta

##prediction and MSE using train dataset
grlasso.pred <-  predict(fit_lasso_viq, x)
grlasso_MSE <-  mean((grlasso.pred - y)^2)
grlasso_MSE

lasso_beta_viq <- as_tibble(fit_lasso_viq$beta, rownames = "variable") %>% 
  rename(beta = 2) %>% 
  filter(variable != "(Intercept)") %>% 
  mutate(group3 = v.group,method = "Grouped Lasso")

#Filter out covariates
lasso_beta_viq |> 
  filter(v.group %in% c("1", "2", "3", "4", "5",
                        "6", "7", "8")) |>  
  ggplot(aes(x = variable, y = round(beta, 5))) + 
  geom_point() + theme_minimal() + geom_hline(yintercept = 0, color = "blue", linetype = "dashed") +
  facet_wrap(~ group3, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + coord_flip() + 
  labs(title = "Lasso Coefficients for 8 Group Model\nWith lambda values extracted from 10-fold cross-validation\nOutcome: WPPSI-VIQ",
       y = "Beta Coefficient", x = "Variable")
```


data prep - WPPSI PIQ
```{r, echo=FALSE}
set.seed(123, "L'Ecuyer-CMRG")

# Define the predictor variables
x_piq <- as.matrix(dat[c(5:7, 9:34)])
y_piq <- as.matrix(dat[, 37])

# group index for X variables
v.group <- as.factor(c(1,1,2,1,6,3,1,3,5,5,5,5,5,3,6,6,6,6,6,7,7,7,2,5,8,8,4,4,4))

gr_lasso_piq<- grpreg(x_piq, y_piq, v.group, penalty="grLasso")
plot(gr_lasso_piq)
```

MODEL -PIQ
```{r, echo=FALSE, fig.height=10, fig.width=10, dpi=300}
cv_lasso_piq <- cv.grpreg(x_piq, y_piq, v.group, 
                        penalty = "grLasso", seed = 123,
                        n.lambda = 200, max.iter = 20000)


#Find the lambda that results in the smallest CV error
best_lasso_piq <- cv_lasso_piq$lambda.min

#Fit model with cross-validated lambda
fit_lasso_piq <- grpreg(x, y, v.group, penalty = "grLasso", lambda = best_lasso_piq)

#Look at coefficients from model with best lambda
fit_lasso_piq$beta

##prediction and MSE using train dataset
grlasso.pred_piq <-  predict(fit_lasso_piq, x)
grlasso_MSE_piq <-  mean((grlasso.pred_piq - y)^2)
grlasso_MSE_piq

lasso_beta_piq <- as_tibble(fit_lasso_piq$beta, rownames = "variable") %>% 
  rename(beta = 2) %>% 
  filter(variable != "(Intercept)") %>% 
  mutate(group3 = v.group,method = "Grouped Lasso")

#Filter out covariates
lasso_beta_piq |> 
  filter(v.group %in% c("1", "2", "3", "4", "5",
                        "6", "7", "8")) |>  
  ggplot(aes(x = variable, y = round(beta, 5))) + 
  geom_point() + theme_minimal() + geom_hline(yintercept = 0, color = "blue", linetype = "dashed") +
  facet_wrap(~ group3, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + coord_flip() + 
  labs(title = "Lasso Coefficients for 8 Group Model\nWith lambda values extracted from 10-fold cross-validation\nOutcome: WPPSI-PIQ",
       y = "Beta Coefficient", x = "Variable")
```
