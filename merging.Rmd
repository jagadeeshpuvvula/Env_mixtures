---
title: "01_merging"
author: "Puvvula"
date: "2022-09-13"
output: pdf_document
---

```{r}
library(tidyverse)
library(skimr)
library(haven)
library(janitor)
library(naniar)

```

Filter outcome data by year of child visit
```{r}
################## OUTCOME ###############################
# In wide format
dt_outcome<- read_sas("/Users/jpuvvula/Documents/data/outcomes.sas7bdat")

#subset for age 3 years (263 obs.)
dat<- dt_outcome[c(1,2,16:18,20,21,23:26,30, 34:40,42:44,46:55,60:63)] |> 
  filter(Visit == "M36")

#236 obs with all values
dt<- dat |> drop_na()

#summary for 3 year outcome
skim(dt)

##subset for age 5 years (193 obs.)
dat<- dt_outcome[c(1:6)] |> 
  filter(Visit == "M60")

#subset for age 7.5-10 years ( obs.)
dat<- dt_outcome[c(1,2,7:15,18:24,28,29,31,34:44,46:55,60:63)] |> 
  filter(Visit == "P3")

#subset for age 7.5-10 years (242 obs.with BRIEF and BASC)
dat<- dt_outcome[c(1,2,18:24,27:29,32:63)] |> 
  filter(Visit == "P4")
```

Missing data viz: Outcome at 3 year
```{r}
gg_miss_var(dat, show_pct = T)

gg_miss_upset(dat, nsets=20, nintersects=NA)
```



```{r}
################# COVARIATES #############################
# In wide format
dt_cov <- read_sas("/Users/jpuvvula/Documents/data/covariates.sas7bdat")

dat<- left_join(dt_out, dt_cov, by="SubjectID")

cat<- names(dat[c(2:10,12,14:17,18,20,21,27,29,35,50:52,53,55,56,58,62,64,65)])
dat[cat] <- lapply(dat[cat], factor)

skim(dat)
```


```{r}
#using outcome subjectID as filter
dt_out<- read_csv("/Users/jpuvvula/Documents/out3_id.csv")

#reading SAS data
############### EXPOSURES ####################################
#In long format - Need to be converted to wide

# BLOOD 216
bl_cd<- read_sas("/Users/jpuvvula/Documents/data/bcd.sas7bdat") |> filter(Visit=="M36")
bl_pb<- read_sas("/Users/jpuvvula/Documents/data/bpb.sas7bdat") |> filter(Visit=="16W")
thg <- read_sas("/Users/jpuvvula/Documents/data/thg.sas7bdat")  |> 
  filter(Visit=="16W") |>
  clean_names()# blood Hg

dat_bld <- rbind(bl_cd, bl_pb, thg)
write_csv(dat_bld, "/Users/jpuvvula/Documents/data/working/dat_bld.csv")

# SERUM
oc_pest<- read_sas("/Users/jpuvvula/Documents/data/ocpest.sas7bdat") |> filter(Visit=="M36")
pbde<- read_sas("/Users/jpuvvula/Documents/data/pbde.sas7bdat") |> filter(Visit=="M36")
pcb<- read_sas("/Users/jpuvvula/Documents/data/pcb.sas7bdat") |> filter(Visit=="M36")
pfas<- read_sas("/Users/jpuvvula/Documents/data/pfas.sas7bdat") |> filter(Visit=="M36")
ct <- read_sas("/Users/jpuvvula/Documents/data/ct.sas7bdat") |> filter(Visit=="M36")

# URINE
arse<- read_sas("/Users/jpuvvula/Documents/data/ars_i_cd.sas7bdat") |> filter(Visit=="M36")
fr<- read_sas("/Users/jpuvvula/Documents/data/fr.sas7bdat") |> filter(Visit=="M36")
op_pest<- read_sas("/Users/jpuvvula/Documents/data/op.sas7bdat") |> filter(Visit=="M36")
pheno<- read_sas("/Users/jpuvvula/Documents/data/phen.sas7bdat") |> filter(Visit=="M36")
bpa<- read_sas("/Users/jpuvvula/Documents/data/phthbpa.sas7bdat") |> filter(Visit=="M36")
pyre<- read_sas("/Users/jpuvvula/Documents/data/pyr.sas7bdat") |> filter(Visit=="M36")

```

Processing exposure data
```{r}
#For Cotinine only (take values from result or from result machine)
ct$Result <- ifelse(is.na(ct$Result), ct$Result_Machine, ct$Result)

#create average for multiple entries [imputing average values]
#Use for PFAS and Cotinine only
dt_imp<- pfas |> 
  group_by(SubjectID, Visit, Analyte_Code) |>
  summarise_at(vars("Result"), mean)

#summaries for all variables
dt <- thg [c(1,2,5,6)] |>
  pivot_wider(names_from = c(Analyte_Code),
              values_from = Result)

dt_out <-dt |> 
  dplyr::group_by(Visit) |>
  skim()

write_csv(dt_out, "con.csv")
```

Single imputation using fill-in method
```{r}


```


