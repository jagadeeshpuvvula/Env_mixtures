---
title: "associations"
author: "Puvvula"
date: "2022-11-03"
output: pdf_document
---

```{r}
#exposure
library(tidyverse)

dat<- read_csv("/Users/jpuvvula/Documents/data/home_16w_imp/mirec_transf/home_exp_fin.csv") |>
  pivot_wider(names_from = analyte, values_from = conc)

# variable 18 for DMA
dat<- dat[c(1,3,5,7,9,11,12,14, 16, 18, 20,22, 24, 25, 27, 29, 31, 33, 35, 37, 39, 41, 42:50, 53)] 

#outcome
dat_out<- read_csv("/Users/jpuvvula/Documents/data/home_16w_imp/mirec_transf/outcome_wide.csv") |>
  select(names(dat_out[c(1,6,7,8)])) |>
  drop_na()

#analytic dataset
dat_fin<- inner_join(dat, dat_out, by="subject_id") |>
  drop_na()

#wide to long for summary table

dat_wide <- dat_fin |> 
  pivot_longer(!subject_id,
               names_to = "measure", values_to = "value")
dat_summ<- dat_wide |> 
    group_by(measure) |>
    summarise(no_obs= n(), null = sum(is.na(value)),
              geometric_mean = geomean(value), geometric_SD = geosd(value),
              arithmatic_mean=mean((value), na.rm=T), arithmatic_std=sd((value), na.rm = T),
              median = median((value), na.rm = T), q25 = quantile(value, .25, na.rm=T),
              q75 = quantile(value, .75, na.rm=T)) |>
    mutate_if(is.numeric, round, 3)
```

Generalized weighted quantile sum regression
```{r}
library(gWQS)

mixture<- names(dat_fin[(2:31)])

wqs_rh<- gwqsrh(bayley_men_mdi ~ wqs,
                    mix_name=mixture,
                    data=dat_fin,
                    q=10, validation=0.6,b=100,b1_pos = F,b1_constr = F,
                    family="gaussian",zilink = log, seed=2022,rh=10)

gwqs_summary_tab(wqs_rh)
gwqsrh_boxplot(wqs_rh, tau = 0.01)
gwqs_weights_tab(wqs_rh)


####### MIREC #########

mixture<- names(wppsi_fin[(8:39)])

wqs_rh<- gwqsrh(fsiq ~ wqs,
                    mix_name=mixture,
                    data=wppsi_fin,
                    q=10, validation=0.6,b=100,b1_pos = F,b1_constr = F,
                    family="gaussian",zilink = log, seed=2022,rh=10)

gwqs_summary_tab(wqs_rh)
gwqsrh_boxplot(wqs_rh, tau = 0.01)
gwqs_weights_tab(wqs_rh)

```

quantile g-computation
```{r}
library(qgcomp)

nb_gcomp_fit<- qgcomp.noboot(bayley_men_mdi ~ . ,
                        expnms = mixture,
                        data = dat_fin,
                        family= gaussian(), q=10)


gcomp_fit<- qgcomp.boot(bayley_men_mdi ~ . ,
                        expnms = mixture,
                        data = dat_fin,
                        family= gaussian(), q=10, B = 250,
                        seed = 2022)

plot(gcomp_fit)

###### MIREC ##########
gcomp_fit<- qgcomp.boot(fsiq ~ . ,
                        expnms = mixture,
                        data = wppsi_fin,
                        family= gaussian(), q=10, B = 250,
                        seed = 2022)

plot(gcomp_fit)


```

Bayesian Kernel machine regression
```{r}
library(bkmr)

out<-wppsi_fin$fsiq

mixture<- wppsi_fin[(8:39)]

set.seed(2021)
bkmr_fit<- kmbayes(y= out, Z = mixture, iter= 100,
                   verbose=T, varsel = T, family = "gaussian")
```




