---
title: "03.2_variable selection"
author: "Jagadeesh Puvvula"
date: "2023-02-21"
output: pdf_document
---


```{r}
library(pacman)
pacman::p_load(tidyverse, janitor)
path <- "E:/BBK17/pj/data_2023apr/obs_w_outcome/"
dat<- read_csv(paste0(path, "wppsi_f_analy.csv")) |>
  select(c(4:45)) |>
  select(-c(31:33,36:39)) |>
  drop_na()
```


```{r, echo=FALSE, message=FALSE}
#Pre-process data
# convert exposures to log and center scale both x and y variables
dat <- dat |>
  mutate_all(~ log10(. + 1)) |>
  mutate_all(~ (. - mean(.)) / sd(.))
```

```{r}
# Define the predictor variables
X <- as.matrix(dat[c(1:32)])
Y <- as.matrix(dat[c(33:35)])

# group index for X variables
group<- as.integer(c(rep(1,times=3), rep(2,times=6), rep(3, times=3),
                         rep(4,times=4), rep(5, times=2), rep(6,times=6),
                         rep(7,times=2), rep(8, times=3), rep(9,times=3)))
```

```{r}
pacman::p_load(gglasso, grpreg, sparsegl, Matrix, glmnet, stabs)
```

# Loop all three outcomes for feature selection using different group lasso models
```{r}
var_selec <- function(X, Y, group) {
  results <- list()
  for (i in 1:3) {
    y <- Y[, i]
    # Group graphical Lasso
    gr_cv <- cv.gglasso(X, y, group=group, loss="ls", pred.loss="L2",  nfolds=10)
    gr_min_beta <- coef(gr_cv, s = gr_cv$lambda.min)[-1]
  
    # Group Lasso
    grpp_cv <- cv.grpreg(X, y, group = group, penalty="grLasso",seed=5678,nfolds = 10)
    grpp_min_beta <- coef(grpp_cv, s = grpp_cv$lambda.min)[-1]
  
    #Sparse lasso
    sparse_cv<- cv.sparsegl(X, y, group = group, family = "gaussian", nfolds = 10)
    sparse_min_beta<- coef(sparse_cv, s= sparse_cv$lambda.min)[-1]


    #Stability selection with error control - input cross-validated lambda.min from cv-glmnet
    stab_lambda_min <- cv.glmnet(X, y, nfolds=10)$lambda.min
    stab_maxCoef <- stabsel(X, y, fitfun = glmnet.lasso_maxCoef, args.fitfun = list(lambda = stab_lambda_min), cutoff = 0.75, PFER = 1)
    stab_maxCoef_selec<- stab_maxCoef$max
  
    # Store results in list
    results[[paste0("outcome", i)]] <- as.data.frame(list(gr_lasso = gr_min_beta, 
                                                          grpp_lasso = grpp_min_beta,
                                                          sparse_lasso = sparse_min_beta,
                                                          stab_cv_glmnet = stab_maxCoef_selec))
  }
  # Return list of results
  return(results)
}
```


```{r}
res<- var_selec(X, Y, group)
```

```{r}
# Add group variable to each list
res <- lapply(res, function(x) {
  df <- as.data.frame(x)
  df$group <- group
  round(df, 3)
})

fsiq<- as.data.frame(res$outcome1)


```

