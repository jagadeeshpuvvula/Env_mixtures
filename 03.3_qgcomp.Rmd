---
title: "03.3_qgcomp"
author: "Jagadeesh Puvvula"
date: "2023-02-14"
output: pdf_document
---

```{r, echo=FALSE, message=FALSE}
library(tidyverse)
library(janitor)
library(qgcomp)
```

```{r, echo=FALSE, message=FALSE}
dat<- read_csv("E:/BBK17/pj/wppsi_exp_out_comb/wppsi_fin.csv") |>
  mutate_if(is.numeric, round, 4) |>
  drop_na() |>
  clean_names() |>
  rename(Pb=pbsg, Hg=hgsg, DMA=dma_sg, DDE= dde_lp, PBDE_47 = pbde47_lp,
         PCB_118=pcb118_lp, PCB_138=pcb138_lp, PCB_153=pcb153_lp,
         PCB_180=pcb180_lp, PFHxS=pf_hx_spl, PFOA=pfoapl, PFOS=pfospl,
         BCEtP=bcetp_sg, BDCPP=bdcpp_sg, DBuP=dbup_sg, DPhP=dphp_sg,
         TCS=tcs_sg, BPA=bpa_sg, MBP=mbp_sg, MBZP=mbzp_sg, MCPP=mcpp_sg,
         sigma_DEHP=dehp, MEP=mep_sg, MIBP=mibp_sg, di_Ethyl_OP=op_de,
         di_Methyl_OP=op_dm, B_PB=b_pb, M_PB=m_pb, P_PB=p_pb)|>
  select(c(Pb, Hg, DMA, DDE, PBDE_47, PCB_118, PCB_138, PCB_153, PCB_180,
          PFHxS, PFOA, PFOS, BCEtP, BDCPP, DBuP, DPhP, TCS, BPA, MBP, MBZP,
          MCPP, sigma_DEHP, MEP, MIBP, di_Ethyl_OP, di_Methyl_OP, 
          B_PB, M_PB, P_PB, wppsi_fsiq, wppsi_viq, wppsi_piq, cohort, city,
          sex, race_bin, cotinine, mom_edu_cat, home_score_total, parity_n, mom_age)) 

dat<- dat |> 
  mutate(across(all_of(c("cohort", "city", "sex", "race_bin", 
                         "parity_n", "mom_edu_cat")), as.factor))

```

For 14 chemicals 
```{r}
dat <- dat |>
  select(4,5,17,18,19,21,20,22,23,24,25,26,28:29,30:41) |>
  mutate_at(vars(1:14), log10) |>
  rename_with(~ paste0("log_", .x), 1:14)


mixture<- names(dat[c(1:14)])
```

#function to loop qgcomp
```{r}
qgcomp_func <- function(outcomes, dat, folder_path, sex_level = NULL, cohort_level = NULL) {
  
  # check if sex and cohort variables exist in data
  has_sex <- "sex" %in% colnames(dat)
  has_cohort <- "cohort" %in% colnames(dat)
  
  # set default values for sex_level and cohort_level if not provided
  if (is.null(sex_level)) {
    if (has_sex) {
      sex_levels <- c("all", "Female", "Male")
    } else {
      sex_levels <- "all"
    }
  } else {
    sex_levels <- sex_level
  }
  
  if (is.null(cohort_level)) {
    if (has_cohort) {
      cohort_levels <- c("all", "home", "mirec")
    } else {
      cohort_levels <- "all"
    }
  } else {
    cohort_levels <- cohort_level
  }
  
  # iterate over sex and cohort levels
  for (sex_level in sex_levels) {
    if (sex_level == "all") {
      sex_data <- dat
      sex_formula <- "sex + "
    } else {
      sex_data <- subset(dat, sex == sex_level)
      sex_formula <- ""
    }
    for (cohort_level in cohort_levels) {
      if (cohort_level == "all") {
        cohort_data <- sex_data
        cohort_formula <- "cohort + city+"
        filename_prefix <- paste0(sex_level, "_all")
      } else if (cohort_level == "home") {
        cohort_data <- subset(sex_data, cohort == "1")
        cohort_formula <- ""
        filename_prefix <- paste0(sex_level, "_home")
      } else if (cohort_level == "mirec") {
        cohort_data <- subset(sex_data, cohort == "2")
        cohort_formula <- ""
        filename_prefix <- paste0(sex_level, "_mirec")
      } else {
        stop("Invalid cohort level")
      }
      
      for(outcome in outcomes){
        formula <- as.formula(paste(outcome, "~ log_DDE + log_PBDE_47 + log_TCS + log_BPA +log_MBP + log_MCPP + log_MBZP + log_sigma_DEHP + log_MEP +log_MIBP + log_di_Ethyl_OP + log_di_Methyl_OP + log_M_PB +log_P_PB + ", sex_formula, cohort_formula,"race_bin + cotinine +mom_edu_cat + home_score_total + parity_n + mom_age"))
        
        nb <- qgcomp.noboot(formula, expnms = mixture, data = cohort_data, family= gaussian(), q=10)
        boot <- qgcomp.boot(formula, expnms = mixture, data = cohort_data, family= gaussian(), q=10, B = 250, seed = 2022)
        save(nb, file = paste0(folder_path, "/", "nb_", filename_prefix, "_", outcome, ".rda"))
        save(boot, file = paste0(folder_path, "/", "boot_", filename_prefix, "_", outcome, ".rda"))
      }
    }
  }
}

```

#run this function to get all results at a folder
```{r}
qgcomp_func(outcomes = c("wppsi_fsiq", "wppsi_viq", "wppsi_piq"), 
            folder_path = "E:/BBK17/pj/test/", 
            sex_level = TRUE, cohort_level = TRUE, 
            dat = dat)
```


#Compile all results from the above loop to a single csv file
```{r}
# set the folder location
folder_location <- "E:/BBK17/pj/test/"

# get the file names in the folder
file_names <- list.files(folder_location)

# create empty data frame to store the results
results <- data.frame(file = character(),
                      estimate = numeric(),
                      lower_ci = numeric(),
                      upper_ci = numeric(),
                      stringsAsFactors = FALSE)

#loops through all .rda files and extract estimates, CI & p-values
for (file_name in file_names) {
  # load the object from the file
  load(file.path(folder_location, file_name))
  # extract the object name using grep or grepl
  object_name <- ls()[grep("^boot|^nb", ls())]
  # extract the required information using the summary function and the object name
  estimate <- get(object_name)$coef["psi1"]
  CI <- get(object_name)$ci
  lower_ci <- CI[1]
  upper_ci <- CI[2]
  p_value <- get(object_name)$pval[2]
  # split file name by "_" and remove ".rda"
  file_parts <- strsplit(gsub("\\.rda", "", file_name), "_")[[1]]
  # assign parts to variables
  part1 <- file_parts[1]
  part2 <- file_parts[2]
  part3 <- file_parts[3]
  part4 <- file_parts[5]
  # print out the values
  cat("File:", file_name, "\n")
  cat("  Estimate:", estimate, "\n")
  cat("  Lower CI:", lower_ci, "\n")
  cat("  Upper CI:", upper_ci, "\n")
  cat("  p-value:", p_value, "\n")
  cat("  Part 1:", part1, "\n")
  cat("  Part 2:", part2, "\n")
  cat("  Part 3:", part3, "\n")
  cat("  Part 4:", part4, "\n")
  # add the results to the data frame
  results <- rbind(results, data.frame(boot_strp = part1,
                                       gender = part2,
                                       cohort = part3,
                                       outcome = part4,
                                       estimate = estimate,
                                       lower_ci = lower_ci,
                                       upper_ci = upper_ci,
                                       p_value = p_value,
                                       stringsAsFactors = FALSE))
  # remove the object from the R environment to avoid conflicts with other objects (all objects saved as nb or boot)
  rm(list = object_name)
}
```


#consolidated results
```{r, echo=FALSE, message=FALSE, fig.height=4, fig.width=6, dpi=300}
res<- read_csv("E:/BBK17/pj/wppsi_results/qgcomp/qgcomp_res.csv")

res$cohort<- factor(res$cohort, levels = c("pooled", "HOME", "MIREC"))

cbbPalette <- c("#D55E00", "#0072B2")

ggplot(res, aes(x = as.factor(model), y = beta, ymin = ll, ymax = ul)) + 
  geom_pointrange(aes(col = neg_beta, shape=bootstrap), 
                  position=position_dodge(width=0.5),size = 0.6) +
  geom_hline(aes(yintercept = 0), linetype="dashed") + 
  scale_colour_manual(values=cbbPalette) +
  scale_y_continuous(breaks = seq(-2.5,5.5,1.5))+
  labs(x=NULL,
       y=expression(paste(beta[q-gcomp]," [95% CI]")),
       title = "Joint association between prenatal chemical mixture during first trimester \nand child IQ",
       caption = "Pooled n=617; HOME-n=139; MIREC-n=478\n
       Effect estimates adjusted for cohort (for pooled only), city (for pooled and MIREC only), \nMom: serum cotinine, education, race, age, parity; Child: gender, HOME-score")+
  theme_bw()+
  theme(axis.line = element_line(colour = "black"))+
  theme(plot.caption = element_text(size = 6),
        plot.title=element_text(size = 11, hjust = 0),
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        text=element_text(size=10),
        axis.text = element_text(size = 10),
        axis.text.x=element_text(size=10,angle=0),
        axis.ticks.x=element_blank(),
        strip.text.x=element_text(size=10,angle=0),
        strip.text.y = element_text(size=12),
        strip.placement = "outside",
        strip.background = element_rect(fill=NULL, colour = NULL),
        legend.box.just = "right",
        legend.spacing = unit(0, "cm"),
        legend.position = c(0.85,0.95),
        legend.box = "vertical",
        legend.direction = "horizontal",
        legend.text = element_text(size = 8),
        legend.key = element_blank(),
        legend.key.height = unit(3, "mm"))+
  facet_grid(.~cohort, scales = "free", switch = "x", space = "free_x")


ggsave("E:/BBK17/pj/wppsi_results/qgcomp/qgcomp_res.tiff", 
       width = 6,height = 4,
       dpi=300)
```


sensitivity testing
```{r}
dat_test <- dat |>
  select(4,5,17,18,19,21,20,22,23,24,25,26,28:29,30:41) |>
  mutate_at(vars(1:14), log10) |>
  rename_with(~ paste0("log_", .x), 1:14)


mixture<- names(dat_test[c(1:14)])

nb_gcomp_fit<- qgcomp.noboot(wppsi_fsiq ~ .,
                             expnms = mixture,
                             data = dat[-c(16,17)],
                             family= gaussian(), q=10)

nb_gcomp_fit


gcomp_fit<- qgcomp.boot(wppsi_piq ~ .,
                        expnms = mixture,
                        data = dat_test[-c(15,16)],
                        family= gaussian(), q=10, B = 250,
                        seed = 2022)
gcomp_fit
```

sensitivity plot
```{r}
res<- read_csv("E:/BBK17/pj/wppsi_results/qgcomp_14chem/qgcomp_prog_rep.csv")

res$cohort<- factor(res$cohort, levels = c("Pooled", "HOME", "MIREC"))

cbbPalette <- c("#D55E00", "#0072B2")

ggplot(res, aes(x = as.factor(model), y = beta, ymin = ll, ymax = ul)) + 
  geom_pointrange(aes(col = sign, shape=bootstrap), 
                  position=position_dodge(width=0.5),size = 0.6) +
  geom_hline(aes(yintercept = 0), linetype="dashed") + 
  scale_colour_manual(values=cbbPalette) +
  labs(x=NULL,
       y=expression(paste(beta[q-gcomp]," [95% CI]")),
       title = "Joint association between prenatal chemical mixture during first trimester and child IQ",
       caption = "Mixture includes 14 environmental chemicals: Triclosan, BPA, POPs (DDE,PBDE-47), Parabens (Methyl-paraben, Propyl-paraben), Phthalates (MBP, MBZP, MCPP, MEP, MIBP, Sigma-DEHP), OP-pesticides (Sigma-di-ethyl-op, Sigma-di-methyl-op)
       Effect estimates adjusted for cohort, city (for pooled), Maternal: serum cotinine, education, race, age, parity; Child: gender, HOME-score
       Effect estimates associated with every 10% increase in the mixture; For bootstrap, estimates generated using 250 random samples")+
  theme_bw()+
  theme(axis.line = element_line(colour = "black"))+
  theme(plot.caption = element_text(size = 6),
        plot.title=element_text(size = 11, hjust = 0),
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        text=element_text(size=10),
        axis.text = element_text(size = 10),
        axis.text.x=element_text(size=10,angle=0),
        axis.ticks.x=element_blank(),
        strip.text.x=element_text(size=10,angle=0),
        strip.text.y = element_text(size=12),
        strip.placement = "outside",
        strip.background = element_rect(fill=NULL, colour = NULL),
        legend.box.just = "right",
        legend.spacing = unit(0, "cm"),
        legend.position = c(0.85,0.95),
        legend.box = "vertical",
        legend.direction = "horizontal",
        legend.text = element_text(size = 8),
        legend.key = element_blank(),
        legend.key.height = unit(3, "mm"))+
  facet_grid(gender~cohort, scales = "free", switch = "x", space = "free_x")


ggsave("E:/BBK17/pj/wppsi_results/qgcomp_14chem/qgcomp_prog_rep.tiff", 
       width = 12,height = 8,
       dpi=300)


```

